<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QLTT L·ªõp h·ªçc ‚Äî B·∫£ng ƒëi·ªÅu khi·ªÉn</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
  <div class="app" role="application">
    <aside class="sidebar" aria-label="Thanh ƒëi·ªÅu h∆∞·ªõng">
      <div class="brand">
        <div class="logo">QL</div>
        <div>
          <div class="title">QLTT L·ªõp h·ªçc</div>
          <div style="font-size:12px;color:var(--muted)">Qu·∫£n l√Ω th√¥ng tin l·ªõp & sinh vi√™n</div>
        </div>
      </div>

      <div class="profile-mini" id="sidebar-profile">
        <div id="side-avatar" style="width:44px;height:44px;border-radius:8px;background:#f3f4f6;overflow:hidden;display:flex;align-items:center;justify-content:center;border:1px solid rgba(0,0,0,0.04)">
          <img id="side-avatar-img" src="" alt="avatar" style="width:100%;height:100%;object-fit:cover;display:none">
          <div id="side-avatar-placeholder" style="font-weight:700;color:var(--muted)">U</div>
        </div>
        <div class="info">
          <div id="side-name" style="font-weight:700">Kh√°ch</div>
          <div id="side-role" style="font-size:12px;color:var(--muted)">Kh√¥ng c√≥ phi√™n</div>
        </div>
      </div>

      <nav class="side-nav" aria-label="Ch·ª©c nƒÉng">
        <button id="nav-dash" class="active">T·ªïng quan</button>
        <button id="nav-classes">L·ªõp h·ªçc</button>
        <button id="nav-schedule">L·ªãch</button>
        <button id="nav-grades">ƒêi·ªÉm s·ªë</button>
        <button id="nav-attendance">ƒêi·ªÉm danh</button>
        <button id="nav-students">Sinh vi√™n</button>
        <button id="nav-settings">C√†i ƒë·∫∑t</button>
      </nav>

      <div style="margin-top:auto; display:flex; gap:8px; align-items:center; justify-content:center">
        <button id="nav-profile" style="padding:8px 12px;border-radius:10px;border:1px solid rgba(16,24,40,0.06);background:transparent;cursor:pointer">H·ªì s∆°</button>
        <button id="nav-logout" style="padding:8px 12px;border-radius:10px;background:var(--accent);color:#fff;border:none;cursor:pointer">ƒêƒÉng xu·∫•t</button>
      </div>
    </aside>

    <section class="main" aria-live="polite">
      <div class="topbar">
        <div style="display:flex; gap:12px; align-items:center;">
          <h2 style="margin:0">T·ªïng quan</h2>
          <div style="font-size:13px;color:var(--muted)">Ch√†o m·ª´ng tr·ªü l·∫°i</div>
        </div>

        <div class="search">
          <input id="global-search" placeholder="T√¨m l·ªõp, sinh vi√™n, th√¥ng b√°o..." />
          <div class="top-actions">
            <button class="icon-btn" id="notifBtn" title="Th√¥ng b√°o">üîî</button>
            <button class="icon-btn" id="quickAdd">Ôºã</button>
            <div style="display:flex; align-items:center; gap:8px;">
              <div id="nav-avatar" style="width:40px;height:40px;border-radius:10px;overflow:hidden;border:1px solid rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center">
                <img id="nav-avatar-img" src="" alt="Avatar" style="width:100%;height:100%;object-fit:cover;display:none">
                <div id="nav-avatar-placeholder" style="font-weight:700;color:var(--muted)">U</div>
              </div>
              <div style="display:flex; flex-direction:column; align-items:flex-start;">
                <div id="nav-user" style="font-weight:700">Kh√°ch</div>
                <div style="font-size:12px;color:var(--muted)" id="nav-role">‚Äî</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid" style="margin-top:6px;">
        <div class="card h-lg" style="grid-column: span 8;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div>
              <h3 style="margin:0">Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h3>
              <div style="font-size:13px;color:var(--muted)">C√°c t∆∞∆°ng t√°c v√† th√¥ng b√°o m·ªõi nh·∫•t</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="icon-btn">B·ªô l·ªçc</button>
              <button class="icon-btn">Xu·∫•t</button>
            </div>
          </div>

          <div class="list" id="recent-activity">
            <div class="item"><div>Th√¥ng b√°o: L·ªãch thi h·ªçc k·ª≥</div><div style="font-size:12px;color:var(--muted)">1 gi·ªù tr∆∞·ªõc</div></div>
            <div class="item"><div>Gi·∫£ng vi√™n c·∫≠p nh·∫≠t ƒëi·ªÉm</div><div style="font-size:12px;color:var(--muted)">H√¥m qua</div></div>
            <div class="item"><div>Th√™m l·ªõp m·ªõi: To√°n 101</div><div style="font-size:12px;color:var(--muted)">2 ng√†y tr∆∞·ªõc</div></div>
          </div>
        </div>

        <div class="card h-sm" style="grid-column: span 4;">
          <h3 style="margin:0 0 12px 0">T·ªïng quan nhanh</h3>
          <div class="stats">
            <div class="stat"><h3 id="stat-classes">0</h3><p>L·ªõp</p></div>
            <div class="stat"><h3 id="stat-students">0</h3><p>Sinh vi√™n</p></div>
            <div class="stat"><h3 id="stat-avg">0</h3><p>ƒêi·ªÉm TB</p></div>
          </div>

          <hr style="margin:12px 0;border:none;border-top:1px solid rgba(0,0,0,0.04)">

          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="icon-btn" id="open-profile">M·ªü h·ªì s∆°</button>
            <button class="icon-btn" id="open-change" style="background:var(--accent);color:#fff;border:none">ƒê·ªïi m·∫≠t kh·∫©u</button>
          </div>
        </div>

        <div class="card" style="grid-column: span 4;">
          <h3 style="margin:0 0 8px 0">L·ªãch s·∫Øp t·ªõi</h3>
          <div class="list" id="upcoming-schedule">
            <div class="item"><div>To√°n 101 ‚Äî Ti·∫øt 3</div><div style="font-size:12px;color:var(--muted)">H√¥m nay 10:00</div></div>
            <div class="item"><div>V·∫≠t l√Ω ‚Äî Th·∫£o lu·∫≠n</div><div style="font-size:12px;color:var(--muted)">Ng√†y mai 14:00</div></div>
          </div>
          <div style="text-align: center; margin-top: 8px;">
            <button class="icon-btn" onclick="window.location.href='schedule.html'" style="background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Xem l·ªãch ƒë·∫ßy ƒë·ªß</button>
          </div>
        </div>

        <div class="card" style="grid-column: span 4;">
          <h3 style="margin:0 0 8px 0">ƒêi·ªÉm s·ªë</h3>
          <div class="stats" style="margin-bottom: 12px;">
            <div class="stat">
              <h3 style="color: #4caf50; margin: 0;">3.2</h3>
              <p style="margin: 4px 0 0 0;">ƒêi·ªÉm TB</p>
            </div>
            <div class="stat">
              <h3 style="color: var(--accent); margin: 0;">5</h3>
              <p style="margin: 4px 0 0 0;">M√¥n qua</p>
            </div>
            <div class="stat">
              <h3 style="color: #ff9800; margin: 0;">2</h3>
              <p style="margin: 4px 0 0 0;">M√¥n xu·∫•t s·∫Øc</p>
            </div>
          </div>
          <div style="text-align: center;">
            <button class="icon-btn" onclick="window.location.href='grades.html'" style="background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Xem chi ti·∫øt</button>
          </div>
        </div>

        <div class="card" style="grid-column: span 4;">
          <h3 style="margin:0 0 8px 0">ƒêi·ªÉm danh</h3>
          <div class="stats" style="margin-bottom: 12px;">
            <div class="stat">
              <h3 style="color: #4caf50; margin: 0;">92.5%</h3>
              <p style="margin: 4px 0 0 0;">Chuy√™n c·∫ßn</p>
            </div>
            <div class="stat">
              <h3 style="color: var(--accent); margin: 0;">44</h3>
              <p style="margin: 4px 0 0 0;">C√≥ m·∫∑t</p>
            </div>
            <div class="stat">
              <h3 style="color: #f44336; margin: 0;">4</h3>
              <p style="margin: 4px 0 0 0;">V·∫Øng m·∫∑t</p>
            </div>
          </div>
          <div style="text-align: center;">
            <button class="icon-btn" onclick="window.location.href='attendance.html'" style="background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Xem chi ti·∫øt</button>
          </div>
        </div>

        <div class="card" style="grid-column: span 8;">
          <h3 style="margin:0 0 8px 0">Danh s√°ch l·ªõp</h3>
          <div class="list" id="classes-list">
            <div class="item"><div>To√°n 101</div><div class="actions-row"><button class="icon-btn">M·ªü</button><button class="icon-btn">S·ª≠a</button></div></div>
            <div class="item"><div>H√≥a h·ªçc 201</div><div class="actions-row"><button class="icon-btn">M·ªü</button><button class="icon-btn">S·ª≠a</button></div></div>
          </div>
        </div>
      </div>

      <footer>
        &copy; 2025 QLTT L·ªõp h·ªçc ‚Äî H·ªá th·ªëng qu·∫£n l√Ω th√¥ng tin l·ªõp h·ªçc
      </footer>
    </section>
  </div>

  <!-- Keep existing modals (profile, change password) with same IDs used by script -->
  <!-- Change Password Modal -->
  <div id="changePwdModal" aria-hidden="true" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(3,7,18,0.36); z-index:1200;">
    <div role="dialog" aria-labelledby="cp-title" style="width:100%; max-width:480px; background:#fff; border-radius:12px; padding:20px; box-shadow:0 12px 36px rgba(2,6,23,0.28); border:1px solid rgba(16,24,40,0.04);">
      <h3 id="cp-title" style="margin:0 0 8px 0; color:#2e7d32;">ƒê·ªïi m·∫≠t kh·∫©u</h3>
      <p id="cp-note" style="margin:0 0 12px 0; color:#6b7280;">Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i v√† m·∫≠t kh·∫©u m·ªõi (t·ªëi thi·ªÉu 8 k√Ω t·ª±).</p>
      <div id="cp-status" style="color:#6b7280; font-size:13px; margin-bottom:8px;"></div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <input id="cp-cur" type="password" placeholder="M·∫≠t kh·∫©u hi·ªán t·∫°i" style="padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);">
        <input id="cp-new" type="password" placeholder="M·∫≠t kh·∫©u m·ªõi" style="padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);">
        <input id="cp-conf" type="password" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi" style="padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);">
        <div id="cp-error" style="color:#e15858; min-height:18px;"></div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
          <button id="cp-cancel" style="padding:8px 10px; border-radius:8px; background:transparent; border:1px solid rgba(0,0,0,0.06); cursor:pointer;">H·ªßy</button>
          <button id="cp-submit" style="padding:8px 12px; border-radius:8px; background:#2e7d32; color:#fff; border:none; cursor:pointer;">C·∫≠p nh·∫≠t</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" aria-hidden="true" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(3,7,18,0.36); z-index:1210;">
    <div role="dialog" aria-labelledby="pf-title" style="width:100%; max-width:520px; background:#fff; border-radius:12px; padding:20px; box-shadow:0 12px 36px rgba(2,6,23,0.28); border:1px solid rgba(16,24,40,0.04);">
      <h3 id="pf-title" style="margin:0 0 8px 0; color:#2e7d32;">H·ªì s∆° c·ªßa t√¥i</h3>
      <p style="margin:0 0 12px 0; color:#6b7280;">Xem v√† c·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n (frontend-demo).</p>
      <div id="pf-status" style="color:#6b7280; font-size:13px; margin-bottom:8px;"></div>
      <div style="display:flex; gap:12px; align-items:flex-start;">
        <div style="min-width:96px; text-align:center;">
          <div id="pf-avatar-wrap" style="width:96px;height:96px;border-radius:12px;background:#f3f4f6;overflow:hidden;display:flex;align-items:center;justify-content:center;border:1px solid rgba(0,0,0,0.04);">
            <img id="pf-avatar-preview" src="" alt="Avatar" style="width:100%;height:100%;object-fit:cover;display:none;">
            <div id="pf-avatar-placeholder" style="font-weight:700;color:#6b7280;">A</div>
          </div>
          <div style="margin-top:8px; display:flex; gap:6px; justify-content:center;">
            <label for="pf-avatar" style="padding:6px 8px;border-radius:8px;background:transparent;border:1px solid rgba(0,0,0,0.06);cursor:pointer;font-size:13px;">Ch·ªçn</label>
            <button id="pf-avatar-remove" type="button" style="padding:6px 8px;border-radius:8px;background:transparent;border:1px solid rgba(0,0,0,0.06);cursor:pointer;font-size:13px;">X√≥a</button>
          </div>
          <input id="pf-avatar" type="file" accept="image/*" style="display:none;">
        </div>

        <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
          <input id="pf-name" type="text" placeholder="T√™n hi·ªÉn th·ªã" style="padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);">
          <input id="pf-email" type="email" placeholder="Email" style="padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);" readonly>
          <input id="pf-phone" type="tel" placeholder="S·ªë ƒëi·ªán tho·∫°i" style="padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);">
          <input id="pf-address" type="text" placeholder="ƒê·ªãa ch·ªâ" style="padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);">
          <select id="pf-role" style="padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);">
            <option value="student">Sinh vi√™n</option>
            <option value="teacher">Gi·∫£ng vi√™n</option>
            <option value="admin">Admin</option>
          </select>

          <div id="pf-error" style="color:#e15858; min-height:18px;"></div>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
            <button id="pf-cancel" style="padding:8px 10px; border-radius:8px; background:transparent; border:1px solid rgba(0,0,0,0.06); cursor:pointer;">H·ªßy</button>
            <button id="pf-save" style="padding:8px 12px; border-radius:8px; background:#2e7d32; color:#fff; border:none; cursor:pointer;">L∆∞u</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/js/main.js"></script>
  <script>
    (function(){
      // existing profile / avatar / change-password logic preserved
      const navUser = document.getElementById('nav-user');
      const navAvatarImg = document.getElementById('nav-avatar-img');
      const navAvatarPlaceholder = document.getElementById('nav-avatar-placeholder');
      const profileBtn = document.getElementById('nav-profile');
      // try both ids: top-nav (nav-change-pwd) or quick button (open-change)
      const changeBtn = document.getElementById('nav-change-pwd') || document.getElementById('open-change');
      const logoutBtn = document.getElementById('nav-logout');
      const modal = document.getElementById('changePwdModal');
      const cpStatus = document.getElementById('cp-status');
      const cpError = document.getElementById('cp-error');
      const curInp = document.getElementById('cp-cur');
      const newInp = document.getElementById('cp-new');
      const confInp = document.getElementById('cp-conf');
      const cpCancel = document.getElementById('cp-cancel');
      const cpSubmit = document.getElementById('cp-submit');
      // profile elements
      const profileModal = document.getElementById('profileModal');
      const pfStatus = document.getElementById('pf-status');
      const pfError = document.getElementById('pf-error');
      const pfName = document.getElementById('pf-name');
      const pfEmail = document.getElementById('pf-email');
      const pfPhone = document.getElementById('pf-phone');
      const pfAddress = document.getElementById('pf-address');
      const pfRole = document.getElementById('pf-role');
      const pfCancel = document.getElementById('pf-cancel');
      const pfSave = document.getElementById('pf-save');
      const pfAvatarInput = document.getElementById('pf-avatar');
      const pfAvatarPreview = document.getElementById('pf-avatar-preview');
      const pfAvatarPlaceholder = document.getElementById('pf-avatar-placeholder');
      const pfAvatarRemove = document.getElementById('pf-avatar-remove');
      let pfAvatarChanged = false;

      if (pfAvatarInput) {
        pfAvatarInput.addEventListener('change', (e) => {
          const f = e.target.files && e.target.files[0];
          if (!f) return;
          const reader = new FileReader();
          reader.onload = function (ev) {
            const dataUrl = ev.target.result;
            pfAvatarPreview.src = dataUrl;
            pfAvatarPreview.style.display = 'block';
            pfAvatarPlaceholder.style.display = 'none';
            pfAvatarInput._dataUrl = dataUrl;
            pfAvatarChanged = true;
          };
          reader.readAsDataURL(f);
        });
      }
      if (pfAvatarRemove) {
        pfAvatarRemove.addEventListener('click', () => {
          try { pfAvatarInput.value = ''; } catch (e) {}
          pfAvatarInput._dataUrl = null;
          pfAvatarChanged = true;
          pfAvatarPreview.src = '';
          pfAvatarPreview.style.display = 'none';
          pfAvatarPlaceholder.textContent = (pfName.value && pfName.value[0]) ? pfName.value[0].toUpperCase() : 'A';
          pfAvatarPlaceholder.style.display = 'flex';
        });
      }

      function getSessionEmail(){ return (localStorage.getItem('sessionEmail') || '').toLowerCase(); }
      function getStoredPwd(email){ try{ const v = localStorage.getItem('userPassword::' + email.toLowerCase()); if(v) return v; }catch(e){} return null; }
      function loadProfile(email){
        if(!email) return null;
        try{ const raw = localStorage.getItem('profile::' + email.toLowerCase()); if(raw) return JSON.parse(raw); }catch(e){}
        return { name: email.split('@')[0] || '', email: email, phone: '', address: '', role: 'student', avatar: null };
      }
      function saveProfile(obj){ if(!obj || !obj.email) return; try{ localStorage.setItem('profile::' + obj.email.toLowerCase(), JSON.stringify(obj)); }catch(e){} }

      function showModal(){
        const email = getSessionEmail();
        if(!email){ alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi ƒë·ªïi m·∫≠t kh·∫©u.'); return; }
        navUser.textContent = email;
        cpStatus.textContent = 'ƒêang ƒë·ªïi m·∫≠t kh·∫©u cho: ' + email;
        cpError.textContent = '';
        curInp.value = newInp.value = confInp.value = '';
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden','false');
        curInp.focus();
      }
      function hideModal(){ modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); }

      function showProfile(){
        const email = getSessionEmail();
        if(!email){ alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem h·ªì s∆°.'); return; }
        const profile = loadProfile(email);
        pfName.value = profile.name || '';
        pfEmail.value = profile.email || email;
        pfPhone.value = profile.phone || '';
        pfAddress.value = profile.address || '';
        pfRole.value = profile.role || 'student';
        pfError.textContent = '';
        pfStatus.textContent = 'H·ªì s∆°: ' + (profile.email || email);

        if(profile.avatar){
          pfAvatarPreview.src = profile.avatar;
          pfAvatarPreview.style.display = 'block';
          pfAvatarPlaceholder.style.display = 'none';
        } else {
          pfAvatarPreview.src = '';
          pfAvatarPreview.style.display = 'none';
          pfAvatarPlaceholder.textContent = (profile.name && profile.name[0]) ? profile.name[0].toUpperCase() : 'A';
          pfAvatarPlaceholder.style.display = 'flex';
        }

        try { pfAvatarInput.value = ''; } catch(e) {}
        pfAvatarInput._dataUrl = profile.avatar || null;
        pfAvatarChanged = false;

        profileModal.style.display = 'flex';
        profileModal.setAttribute('aria-hidden','false');
        pfName.focus();
      }
      function hideProfile(){ profileModal.style.display = 'none'; profileModal.setAttribute('aria-hidden','true'); }

      (function initNav(){
        const email = getSessionEmail();
        if(email){
          const profile = loadProfile(email);
          navUser.textContent = (profile && profile.name) ? profile.name : email;
          if(profile && profile.avatar){
            navAvatarImg.src = profile.avatar;
            navAvatarImg.style.display = 'block';
            navAvatarPlaceholder.style.display = 'none';
          } else {
            navAvatarImg.src = '';
            navAvatarImg.style.display = 'none';
            navAvatarPlaceholder.textContent = (profile && profile.name && profile.name[0]) ? profile.name[0].toUpperCase() : 'U';
            navAvatarPlaceholder.style.display = 'flex';
          }
          // sidebar mini
          try {
            document.getElementById('side-name').textContent = (profile && profile.name) ? profile.name : email;
            document.getElementById('side-role').textContent = (profile && profile.role) ? profile.role : '‚Äî';
            const sideImg = document.getElementById('side-avatar-img');
            const sidePl = document.getElementById('side-avatar-placeholder');
            if(profile && profile.avatar){
              sideImg.src = profile.avatar; sideImg.style.display = 'block'; sidePl.style.display = 'none';
            } else { sideImg.style.display = 'none'; sidePl.textContent = (profile && profile.name && profile.name[0]) ? profile.name[0].toUpperCase() : 'U'; sidePl.style.display = 'flex'; }
          } catch(e){}
        } else {
          navUser.textContent = 'Kh√°ch';
          navAvatarImg.src = '';
          navAvatarImg.style.display = 'none';
          navAvatarPlaceholder.textContent = 'U';
          navAvatarPlaceholder.style.display = 'flex';
        }
      })();

      if (changeBtn) changeBtn.addEventListener('click', showModal);
      cpCancel.addEventListener('click', hideModal);
      modal.addEventListener('click', (e)=> { if(e.target === modal) hideModal(); });

      cpSubmit.addEventListener('click', ()=>{
        cpError.textContent = '';
        const email = getSessionEmail();
        if(!email){ cpError.textContent = 'Phi√™n ƒëƒÉng nh·∫≠p kh√¥ng t·ªìn t·∫°i.'; return; }
        const cur = (curInp.value || '');
        const np = (newInp.value || '');
        const cf = (confInp.value || '');
        if(np.length < 8){ cpError.textContent = 'M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±.'; return; }
        if(np !== cf){ cpError.textContent = 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp.'; return; }
        const stored = getStoredPwd(email);
        if(stored === null){ cpError.textContent = 'Kh√¥ng t√¨m th·∫•y m·∫≠t kh·∫©u l∆∞u tr·ªØ (demo).'; return; }
        if(cur !== stored){ cpError.textContent = 'M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng.'; return; }
        try{ localStorage.setItem('userPassword::' + email.toLowerCase(), np); localStorage.setItem('pwChanged::' + email.toLowerCase(), Date.now().toString()); }catch(e){}
        cpStatus.textContent = 'ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng.';
        setTimeout(()=> { hideModal(); cpStatus.textContent = ''; }, 900);
      });

      profileBtn.addEventListener('click', showProfile);
      pfCancel.addEventListener('click', hideProfile);
      profileModal.addEventListener('click', (e)=> { if(e.target === profileModal) hideProfile(); });

      pfSave.addEventListener('click', ()=>{
        pfError.textContent = '';
        const name = (pfName.value || '').trim();
        const email = (pfEmail.value || '').trim().toLowerCase();
        const phone = (pfPhone.value || '').trim();
        const address = (pfAddress.value || '').trim();
        const role = (pfRole.value || 'student');
        if(!name){ pfError.textContent = 'T√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.'; return; }
        if(!/^\S+@\S+\.\S+$/.test(email)){ pfError.textContent = 'Email kh√¥ng h·ª£p l·ªá.'; return; }

        const existing = loadProfile(email);
        const avatar = pfAvatarChanged ? (pfAvatarInput._dataUrl || null) : (existing && existing.avatar ? existing.avatar : null);
        const obj = { name, email, phone, address, role, avatar };
        saveProfile(obj);

        navUser.textContent = name;
        if(avatar){
          navAvatarImg.src = avatar; navAvatarImg.style.display = 'block'; navAvatarPlaceholder.style.display = 'none';
        } else {
          navAvatarImg.src = ''; navAvatarImg.style.display = 'none'; navAvatarPlaceholder.textContent = (name && name[0]) ? name[0].toUpperCase() : 'U'; navAvatarPlaceholder.style.display = 'flex';
        }

        // update sidebar mini avatar/name/role
        try {
          const sideImg = document.getElementById('side-avatar-img');
          const sidePl = document.getElementById('side-avatar-placeholder');
          document.getElementById('side-name').textContent = name;
          document.getElementById('side-role').textContent = role;
          if(avatar){ sideImg.src = avatar; sideImg.style.display = 'block'; sidePl.style.display = 'none'; }
          else { sideImg.style.display = 'none'; sidePl.textContent = (name && name[0]) ? name[0].toUpperCase() : 'U'; sidePl.style.display = 'flex'; }
        } catch(e){}

        pfAvatarChanged = false;
        try { pfAvatarInput._dataUrl = avatar || null; } catch(e) {}
        pfStatus.textContent = 'C·∫≠p nh·∫≠t h·ªì s∆° th√†nh c√¥ng.';
        setTimeout(()=> { hideProfile(); pfStatus.textContent = ''; }, 800);
      });

      logoutBtn.addEventListener('click', ()=>{
        try{ localStorage.removeItem('sessionEmail'); }catch(e){}
        window.location.href = './login.html';
      });

      // quick access buttons wired to modals
      document.getElementById('open-profile')?.addEventListener('click', showProfile);
      document.getElementById('open-change')?.addEventListener('click', showModal);

      // Navigation handlers
      document.getElementById('nav-schedule').addEventListener('click', () => {
        window.location.href = 'schedule.html';
      });
      document.getElementById('nav-grades').addEventListener('click', () => {
        window.location.href = 'grades.html';
      });
      document.getElementById('nav-attendance').addEventListener('click', () => {
        window.location.href = 'attendance.html';
      });
      document.getElementById('nav-classes').addEventListener('click', () => {
        // Stay on current page for now
      });
      document.getElementById('nav-students').addEventListener('click', () => {
        // Stay on current page for now
      });
      document.getElementById('nav-settings').addEventListener('click', () => {
        // Stay on current page for now
      });

      // Update upcoming schedule on dashboard
      function updateUpcomingSchedule() {
        const upcomingList = document.getElementById('upcoming-schedule');
        if (!upcomingList) return;

        // Sample upcoming classes data
        const upcomingClasses = [
          { subject: 'To√°n 101', time: 'H√¥m nay 08:00', room: 'A101' },
          { subject: 'V·∫≠t l√Ω 201', time: 'H√¥m nay 10:00', room: 'B205' },
          { subject: 'Tin h·ªçc 401', time: 'Ng√†y mai 14:00', room: 'D401' },
          { subject: 'Anh vƒÉn 501', time: 'Th·ª© 4 08:00', room: 'E501' }
        ];

        upcomingList.innerHTML = '';
        upcomingClasses.forEach(cls => {
          const item = document.createElement('div');
          item.className = 'item';
          item.innerHTML = `
            <div>${cls.subject} ‚Äî ${cls.room}</div>
            <div style="font-size:12px;color:var(--muted)">${cls.time}</div>
          `;
          upcomingList.appendChild(item);
        });
      }

      // Initialize upcoming schedule
      updateUpcomingSchedule();
    })();
  </script>
</body>
</html>